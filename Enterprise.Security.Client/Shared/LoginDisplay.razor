@using Microsoft.AspNetCore.Components.Authorization
@using Enterprise.Security.Client.Infrastructure.Auth
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<AuthorizeView>
    <Authorized>
        <div class="dropdown">
            <button class="btn btn-link text-decoration-none dropdown-toggle d-flex align-items-center gap-2 p-0 text-dark"
                    type="button"
                    id="userDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">

                @* Avatar con Iniciales *@
                <div class="user-avatar">
                    @GetInitials(context.User.Identity?.Name)
                </div>

                <div class="d-none d-md-block text-start">
                    <div class="fw-bold small text-truncate" style="max-width: 150px;">
                        @context.User.Identity?.Name
                    </div>
                    <div class="text-muted" style="font-size: 0.7rem;">Conectado</div>
                </div>
            </button>

            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2" aria-labelledby="userDropdown">
                <li>
                    <div class="px-3 py-2 border-bottom mb-2">
                        <span class="d-block small text-muted">Usuario</span>
                        <span class="fw-bold text-dark">@context.User.Identity?.Name</span>
                    </div>
                </li>
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2" href="profile">
                        <i class="bi bi-person-gear"></i> Mi Perfil
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <button class="dropdown-item d-flex align-items-center gap-2 text-danger" @onclick="BeginLogOut">
                        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                    </button>
                </li>
            </ul>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="d-flex gap-2">
            <a href="register" class="btn btn-sm btn-outline-primary fw-semibold">
                Registrarse
            </a>
            <a href="login" class="btn btn-sm btn-primary fw-semibold shadow-sm">
                Ingresar
            </a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private async Task BeginLogOut()
    {
        // 1. Obtener el proveedor personalizado
        var customAuthProvider = (CustomAuthenticationStateProvider)AuthStateProvider;

        // 2. Ejecutar lógica de salida (Limpiar token y notificar estado)
        await customAuthProvider.LogoutAsync();

        // 3. Redirigir al login
        Navigation.NavigateTo("/login");
    }

    // Método auxiliar para obtener iniciales (ej: "Marco Lopez" -> "ML")
    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "U";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();

        return $"{parts[0][0]}{parts[1][0]}".ToUpper();
    }
}