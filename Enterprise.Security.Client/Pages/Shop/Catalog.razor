@page "/catalog"
@using Enterprise.Security.Client.Core.DTOs.Inventory.Products
@using Enterprise.Security.Client.Core.Interfaces
@using Enterprise.Security.Client.Core.Common
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IProductService ProductService
@inject ICartService CartService
@inject NavigationManager Navigation

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Catálogo de Productos</h2>
            <p class="text-muted mb-0">Explora y agrega productos a tu pedido.</p>
        </div>
        <div class="d-flex gap-3">
            <button class="btn btn-outline-primary shadow-sm d-flex align-items-center gap-2" @onclick='() => Navigation.NavigateTo("/cart")'>
                <i class="bi bi-cart3"></i> Ir al Carrito
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(feedbackMessage))
    {
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
            <div class="toast show align-items-center text-white @(isSuccessFeedback ? "bg-success" : "bg-danger") border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body d-flex align-items-center">
                        <i class="bi @(isSuccessFeedback ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") fs-5 me-2"></i>
                        @feedbackMessage
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => feedbackMessage = null"></button>
                </div>
            </div>
        </div>
    }

    <div class="card border-0 shadow-sm mb-4 bg-white" style="border-radius: var(--radius-md);">
        <div class="card-body p-3">
            <div class="row">
                <div class="col-md-6 col-lg-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0 bg-light" placeholder="Buscar producto o SKU..." @bind="searchText" @bind:event="oninput" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-4 overflow-auto pb-2" style="scrollbar-width: thin;">
        <button class="btn rounded-pill px-4 @(string.IsNullOrEmpty(selectedCategory) ? "btn-primary shadow-sm" : "btn-white text-muted border shadow-sm")"
                @onclick='() => selectedCategory = ""'>
            Todas
        </button>
        @foreach (var cat in products.Select(p => p.CategoryName).Distinct().Where(c => !string.IsNullOrEmpty(c)))
        {
            <button class="btn rounded-pill text-nowrap px-4 @(selectedCategory == cat ? "btn-primary shadow-sm" : "btn-white text-muted border shadow-sm")"
                    @onclick="() => selectedCategory = cat">
                @cat
            </button>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5 my-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-muted fw-medium">Cargando catálogo...</p>
        </div>
    }
    else if (!FilteredProducts.Any())
    {
        <div class="text-center py-5">
            <div class="mb-3 text-muted opacity-25">
                <i class="bi bi-search display-1"></i>
            </div>
            <h5 class="text-muted">No se encontraron productos</h5>
            <p class="text-muted small">Intenta con otro término de búsqueda.</p>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            @foreach (var product in FilteredProducts)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm border-0 product-card overflow-hidden" style="border-radius: var(--radius-lg);">

                        <div class="position-relative bg-light d-flex align-items-center justify-content-center" style="height: 220px; border-bottom: 1px solid var(--border-color);">
                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                            {
                                <img src="@product.ImageUrl" class="h-100 w-100" style="object-fit: cover;" alt="@product.Name">
                            }
                            else
                            {
                                <i class="bi bi-image fs-1 text-muted opacity-25"></i>
                            }

                            <div class="position-absolute top-0 start-0 p-2 d-flex flex-column gap-1">
                                <span class="badge bg-dark bg-opacity-75">SKU: @product.SKU</span>
                            </div>

                            @if (product.StockQuantity <= 0)
                            {
                                <div class="position-absolute top-0 end-0 p-2">
                                    <span class="badge bg-danger shadow-sm">Agotado</span>
                                </div>
                            }
                            else if (product.StockQuantity <= product.MinStockLevel)
                            {
                                <div class="position-absolute top-0 end-0 p-2">
                                    <span class="badge bg-warning text-dark shadow-sm">Últimas @product.StockQuantity</span>
                                </div>
                            }
                        </div>

                        <div class="card-body d-flex flex-column p-4">
                            <h5 class="card-title fw-bold text-dark mb-1 text-truncate" title="@product.Name">@product.Name</h5>
                            <p class="card-text small text-muted mb-3" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                @product.Description
                            </p>

                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-end mb-3">
                                    <div>
                                        <span class="text-muted small d-block lh-1">Precio Unit.</span>
                                        <span class="fs-4 fw-bold text-primary">@product.UnitPrice.ToString("C")</span>
                                    </div>
                                    <div class="text-end">
                                        <span class="text-muted small d-block lh-1">Disp.</span>
                                        <span class="fw-semibold @(product.StockQuantity > 0 ? "text-success" : "text-danger")">@product.StockQuantity u.</span>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <div class="input-group" style="width: 100px;">
                                        <input type="number" class="form-control text-center bg-light border-0 fw-semibold"
                                               min="1" max="@product.StockQuantity"
                                               value="@GetQuantityForProduct(product.Id)"
                                               @onchange="@(e => SetQuantityForProduct(product.Id, e.Value))"
                                               disabled="@(product.StockQuantity <= 0)" />
                                    </div>

                                    <button class="btn btn-primary flex-grow-1 shadow-sm fw-medium d-flex justify-content-center align-items-center gap-2"
                                            @onclick="() => AddToCart(product)"
                                            disabled="@(product.StockQuantity <= 0)">
                                        <i class="bi bi-cart-plus"></i> Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    /* Efecto Hover para las tarjetas */
    .product-card {
        transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

        .product-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg) !important;
        }
</style>

@code {
    private List<ProductDto> products = new();
    private bool isLoading = true;
    private string searchText = "";
    private string selectedCategory = "";

    // Diccionario para controlar la cantidad
    private Dictionary<Guid, int> _selectionQuantities = new();

    // Feedback
    private string? feedbackMessage;
    private bool isSuccessFeedback;

    private IEnumerable<ProductDto> FilteredProducts => products
        .Where(p => string.IsNullOrWhiteSpace(searchText) ||
                    p.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    p.SKU.Contains(searchText, StringComparison.OrdinalIgnoreCase))
        .Where(p => string.IsNullOrWhiteSpace(selectedCategory) ||
                    p.CategoryName == selectedCategory);

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        // Obtenemos todos y filtramos solo los activos para el cliente
        var result = await ProductService.GetAllAsync();
        if (result.Success && result.Data != null)
        {
            products = result.Data.Where(p => p.IsActive).ToList();
        }

        await CartService.InitializeCart();
        isLoading = false;
    }

    private int GetQuantityForProduct(Guid productId)
    {
        return _selectionQuantities.ContainsKey(productId) ? _selectionQuantities[productId] : 1;
    }

    private void SetQuantityForProduct(Guid productId, object? value)
    {
        if (int.TryParse(value?.ToString(), out int qty) && qty > 0)
        {
            if (_selectionQuantities.ContainsKey(productId))
                _selectionQuantities[productId] = qty;
            else
                _selectionQuantities.Add(productId, qty);
        }
    }

    private async Task AddToCart(ProductDto product)
    {
        int qty = GetQuantityForProduct(product.Id);

        if (qty > product.StockQuantity)
        {
            ShowFeedback($"Solo hay {product.StockQuantity} unidades disponibles.", false);
            return;
        }

        await CartService.AddToCart(product, qty);

        if (_selectionQuantities.ContainsKey(product.Id))
            _selectionQuantities[product.Id] = 1;

        // Mostrar Toast temporal
        ShowFeedback($"Se agregaron {qty}x {product.Name} al carrito.", true);

        // Ocultar el toast después de 3 segundos automáticamente
        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            feedbackMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }

    private void ShowFeedback(string msg, bool success)
    {
        feedbackMessage = msg;
        isSuccessFeedback = success;
    }
}