@page "/my-invoices"
@using Enterprise.Security.Client.Core.DTOs.Invoicing
@using Enterprise.Security.Client.Core.Interfaces
@using Enterprise.Security.Client.Core.Common
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = Permissions.Invoices.ViewMy)]
@inject IInvoiceService InvoiceService

<div class="container-fluid py-4">
    <div class="d-flex align-items-center mb-4 gap-3">
        <h2 class="fw-bold text-dark mb-0">Mis Facturas</h2>
        @if (invoices.Any())
        {
            <span class="badge bg-light text-secondary border rounded-pill px-3 py-2">
                @invoices.Count documentos
            </span>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5 my-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-muted fw-medium">Buscando documentos...</p>
        </div>
    }
    else if (!invoices.Any())
    {
        <div class="card border-0 shadow-sm" style="border-radius: var(--radius-lg);">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center bg-light rounded-circle" style="width: 100px; height: 100px;">
                        <i class="bi bi-receipt text-muted opacity-50" style="font-size: 3rem;"></i>
                    </div>
                </div>
                <h4 class="fw-bold text-dark">No tienes facturas emitidas</h4>
                <p class="text-muted">Tus facturas aparecerán aquí cuando tus pedidos sean procesados.</p>
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0 overflow-hidden" style="border-radius: var(--radius-lg);">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-uppercase small text-muted fw-bold">
                        <tr>
                            <th class="ps-4 py-3 border-0">Nro. Documento</th>
                            <th class="py-3 border-0">Fecha Emisión</th>
                            <th class="py-3 border-0">Subtotal</th>
                            <th class="py-3 border-0">Impuestos</th>
                            <th class="py-3 border-0">Total Pagado</th>
                            <th class="text-end pe-4 py-3 border-0">Detalle</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var invoice in invoices)
                        {
                            <tr class="border-bottom-0">
                                <td class="ps-4 fw-bold font-monospace text-primary">
                                    <i class="bi bi-file-earmark-text me-2 text-muted"></i>@invoice.InvoiceNumber
                                </td>
                                <td class="text-muted small">@invoice.IssuedDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="text-muted">@invoice.SubTotal.ToString("C")</td>
                                <td class="text-muted">@invoice.TaxAmount.ToString("C")</td>
                                <td class="fw-bold text-dark fs-6">@invoice.TotalAmount.ToString("C")</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light text-primary border shadow-sm fw-medium" @onclick="() => ShowDetails(invoice)">
                                        <i class="bi bi-eye"></i> Ver
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@* --- MODAL DE DETALLE TIPO RECIBO --- *@
@if (selectedInvoice != null)
{
    <div class="modal fade show d-block backdrop-blur" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg border-0 rounded-4">

                <div class="modal-header border-bottom pb-4 bg-light align-items-start rounded-top-4">
                    <div>
                        <h4 class="modal-title fw-bold text-dark mb-1">
                            Factura Comercial
                        </h4>
                        <div class="text-muted font-monospace small">No. @selectedInvoice.InvoiceNumber</div>
                    </div>
                    <div class="text-end">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Total Pagado</div>
                        <h3 class="fw-bold text-primary mb-0">@selectedInvoice.TotalAmount.ToString("C")</h3>
                    </div>
                </div>

                <div class="modal-body p-4">
                    <div class="row mb-4 g-3 bg-light-subtle p-3 rounded-3 border">
                        <div class="col-sm-6">
                            <span class="d-block small text-muted text-uppercase fw-bold mb-1">Facturado a:</span>
                            <div class="fw-semibold text-dark">@selectedInvoice.ClientName</div>
                            @if (selectedInvoice.OrderId.HasValue)
                            {
                                <div class="text-muted small mt-1"><i class="bi bi-link-45deg me-1"></i>Ref. Pedido: <span class="font-monospace">@selectedInvoice.OrderId.Value.ToString().Substring(0, 8).ToUpper()</span></div>
                            }
                        </div>
                        <div class="col-sm-6 text-sm-end">
                            <span class="d-block small text-muted text-uppercase fw-bold mb-1">Detalles de Emisión:</span>
                            <div class="text-dark small mb-1"><strong>Fecha:</strong> @selectedInvoice.IssuedDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                            <div class="text-dark small">
                                <strong>Agente:</strong>
                                @(string.IsNullOrEmpty(selectedInvoice.SellerName) ? "Sistema E-commerce" : selectedInvoice.SellerName)
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive border rounded-3 mb-4">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="ps-3 border-0 py-2">Artículo</th>
                                    <th class="text-center border-0 py-2">Cant.</th>
                                    <th class="text-end border-0 py-2">P. Unitario</th>
                                    <th class="text-end pe-3 border-0 py-2">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in selectedInvoice.Items)
                                {
                                    <tr class="border-top">
                                        <td class="ps-3 py-3">
                                            <div class="fw-semibold text-dark">@item.ProductName</div>
                                            <div class="small text-muted font-monospace">@item.ProductSku</div>
                                        </td>
                                        <td class="text-center text-dark">@item.Quantity</td>
                                        <td class="text-end text-muted small">@item.UnitPrice.ToString("C")</td>
                                        <td class="text-end pe-3 fw-medium text-dark">@item.SubTotal.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="row justify-content-end">
                        <div class="col-sm-6 col-md-5">
                            <div class="d-flex justify-content-between mb-2 text-muted small">
                                <span>Subtotal:</span>
                                <span>@selectedInvoice.SubTotal.ToString("C")</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3 text-muted small">
                                <span>Impuestos:</span>
                                <span>@selectedInvoice.TaxAmount.ToString("C")</span>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-2">
                                <span class="fw-bold text-dark">Total:</span>
                                <span class="fw-bold text-dark">@selectedInvoice.TotalAmount.ToString("C")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-top-0 pt-0 pb-4 px-4 bg-white d-flex justify-content-between">
                    <button class="btn btn-outline-secondary d-flex align-items-center gap-2" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimir Copia
                    </button>
                    <button type="button" class="btn btn-primary px-4" @onclick="() => selectedInvoice = null">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .backdrop-blur {
        background-color: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
    }

    @@media print {
        .modal {
            position: absolute !important;
            left: 0;
            top: 0;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .modal-dialog {
            max-width: 100%;
            margin: 0;
            padding: 0;
            align-items: flex-start !important;
            min-height: auto !important;
            transform: none !important;
        }

        .modal-content {
            border: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        .modal-footer, .btn-close {
            display: none !important;
        }
    }
</style>

@code {
    private List<InvoiceResponseDto> invoices = new();
    private bool isLoading = true;
    private InvoiceResponseDto? selectedInvoice;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var result = await InvoiceService.GetMyInvoicesAsync();
        if (result.Success)
        {
            invoices = result.Data!.OrderByDescending(x => x.IssuedDate).ToList();
        }
        isLoading = false;
    }

    private void ShowDetails(InvoiceResponseDto invoice)
    {
        selectedInvoice = invoice;
    }
}