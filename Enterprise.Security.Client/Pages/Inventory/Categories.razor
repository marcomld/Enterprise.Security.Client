@page "/categories"
@using Enterprise.Security.Client.Core.DTOs.Inventory.Categories
@using Enterprise.Security.Client.Core.Interfaces
@using Enterprise.Security.Client.Core.Common
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = Permissions.Categories.View)]
@inject ICategoryService CategoryService
@inject IJSRuntime JS

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Categorías</h2>
            <p class="text-muted mb-0">Clasificación y organización del inventario.</p>
        </div>
        <AuthorizeView Policy="@Permissions.Categories.Create">
            <button class="btn btn-primary shadow-sm d-flex align-items-center gap-2 px-4" @onclick="ShowCreateForm">
                <i class="bi bi-plus-lg"></i>
                <span>Nueva Categoría</span>
            </button>
        </AuthorizeView>
    </div>

    @if (!string.IsNullOrEmpty(feedbackMessage))
    {
        <div class="alert @(isSuccessFeedback ? "alert-success" : "alert-danger") alert-dismissible fade show shadow-sm border-0 mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi @(isSuccessFeedback ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") fs-4 me-3"></i>
                <div>
                    <strong>@(isSuccessFeedback ? "¡Éxito!" : "Atención")</strong> @feedbackMessage
                </div>
            </div>
            <button type="button" class="btn-close" @onclick="() => feedbackMessage = null"></button>
        </div>
    }

    <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: var(--radius-lg);">

        <div class="card-header bg-white border-bottom-0 pt-4 px-4 pb-0">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0 bg-light"
                               placeholder="Buscar categoría..."
                               @bind="searchTerm"
                               @bind:event="oninput" />
                    </div>
                </div>
                <div class="col-md-8 text-end d-none d-md-block">
                    <span class="text-muted small">Mostrando @FilteredCategories.Count() registros</span>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted fw-medium">Cargando catálogo...</p>
                </div>
            }
            else if (!FilteredCategories.Any())
            {
                <div class="text-center py-5">
                    <div class="mb-3 text-muted opacity-25">
                        <i class="bi bi-folder-x display-1"></i>
                    </div>
                    <h5 class="text-muted">No se encontraron categorías</h5>
                    @if (!string.IsNullOrEmpty(searchTerm))
                    {
                        <p class="text-muted small">Intenta con otro término de búsqueda.</p>
                    }
                    else
                    {
                        <p class="text-muted small">Comienza creando la primera categoría.</p>
                    }
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-uppercase text-muted small fw-bold">
                            <tr>
                                <th class="ps-4 py-3 border-0">Nombre</th>
                                <th class="py-3 border-0">Descripción</th>
                                <th class="py-3 border-0">Estado</th>
                                <th class="text-end pe-4 py-3 border-0">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var category in FilteredCategories)
                            {
                                <tr class="border-bottom-0">
                                    <td class="ps-4 py-3 fw-semibold text-dark">
                                        @category.Name
                                    </td>
                                    <td class="text-muted small">
                                        @category.Description
                                    </td>
                                    <td>
                                        @if (category.IsActive)
                                        {
                                            <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3">
                                                Activo
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill px-3">
                                                Inactivo
                                            </span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="d-flex justify-content-end gap-2">
                                            <AuthorizeView Policy="@Permissions.Categories.Edit">
                                                <button class="btn btn-sm btn-action-subtle btn-primary-subtle"
                                                        @onclick="() => ShowEditForm(category)"
                                                        title="Editar">
                                                    <i class="bi bi-pencil-fill"></i>
                                                </button>

                                                @if (category.IsActive)
                                                {
                                                    <button class="btn btn-sm btn-action-subtle btn-danger-subtle"
                                                            @onclick="() => PromptToggleStatus(category)"
                                                            title="Desactivar">
                                                        <i class="bi bi-slash-circle"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-action-subtle btn-success-subtle"
                                                            @onclick="() => PromptToggleStatus(category)"
                                                            title="Reactivar">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                }
                                            </AuthorizeView>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@if (showForm)
{
    <div class="modal fade show d-block backdrop-blur" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">
                        @(isEditing ? "Editar Categoría" : "Nueva Categoría")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseForm"></button>
                </div>
                <div class="modal-body p-4">
                    <EditForm Model="@currentCategory" OnValidSubmit="SaveCategory">
                        <DataAnnotationsValidator />

                        <div class="form-floating mb-3">
                            <InputText id="catName" class="form-control" @bind-Value="currentCategory.Name" placeholder="Nombre" />
                            <label for="catName">Nombre de la Categoría</label>
                            <ValidationMessage For="@(() => currentCategory.Name)" />
                        </div>

                        <div class="form-floating mb-3">
                            <InputTextArea id="catDesc" class="form-control" @bind-Value="currentCategory.Description" placeholder="Descripción" style="height: 100px;" />
                            <label for="catDesc">Descripción (Opcional)</label>
                            <ValidationMessage For="@(() => currentCategory.Description)" />
                        </div>

                        @if (isEditing)
                        {
                            <div class="form-check form-switch mb-3">
                                <InputCheckbox id="catActive" class="form-check-input" @bind-Value="currentCategory.IsActive" />
                                <label class="form-check-label" for="catActive">Categoría Activa</label>
                            </div>
                        }

                        <div class="d-grid gap-2 mt-4 pt-2 border-top">
                            <button type="submit" class="btn btn-primary shadow-sm" disabled="@isProcessing">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                            
                                    <span>Guardando...</span>
                                }
                                else
                                {
                                    <span>@(isEditing ? "Guardar Cambios" : "Crear Categoría")</span>
                                }
                            </button>
                            <button type="button" class="btn btn-light text-muted" @onclick="CloseForm">Cancelar</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@if (categoryToToggle != null)
{
    <div class="modal fade show d-block backdrop-blur" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content shadow rounded-4 border-0">
                <div class="modal-body text-center p-4">
                    <div class="mb-3">
                        @if (categoryToToggle.IsActive)
                        {
                            <div class="rounded-circle bg-danger-subtle text-danger d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="bi bi-slash-circle fs-2"></i>
                            </div>
                        }
                        else
                        {
                            <div class="rounded-circle bg-success-subtle text-success d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="bi bi-check-circle fs-2"></i>
                            </div>
                        }
                </div>
                <h5 class="fw-bold">¿Estás seguro?</h5>
                <p class="text-muted small">
                    @(categoryToToggle.IsActive
                                        ? $"Vas a desactivar '{categoryToToggle.Name}'."
                                        : $"Vas a reactivar '{categoryToToggle.Name}'.")
                    </p>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn @(categoryToToggle.IsActive ? "btn-danger" : "btn-success")" @onclick="ExecuteToggleStatus">
                            Sí, @(categoryToToggle.IsActive ? "Desactivar" : "Activar")
                        </button>
                        <button class="btn btn-link text-decoration-none text-muted btn-sm" @onclick="() => categoryToToggle = null">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Estilos Locales (Enterprise System) */
    .backdrop-blur {
        background-color: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
    }

    .bg-success-subtle {
        background-color: #dcfce7;
        color: #15803d;
    }

    .bg-danger-subtle {
        background-color: #fee2e2;
        color: #b91c1c;
    }

    .bg-secondary-subtle {
        background-color: #f1f5f9;
        color: #64748b;
    }

    /* Botones de Acción Sutiles */
    .btn-action-subtle {
        border: none;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        transition: all 0.2s;
    }

    .btn-primary-subtle {
        background-color: #e0f2fe;
        color: #0369a1;
    }

        .btn-primary-subtle:hover {
            background-color: #0284c7;
            color: white;
            transform: translateY(-2px);
        }

    .btn-danger-subtle:hover {
        background-color: #dc2626;
        color: white;
        transform: translateY(-2px);
    }

    .btn-success-subtle:hover {
        background-color: #16a34a;
        color: white;
        transform: translateY(-2px);
    }
</style>

@code {
    // --- VARIABLES ---
    private List<CategoryDto> categories = new();
    private bool isLoading = true;
    private bool isProcessing = false;
    private string searchTerm = "";

    // Feedback
    private string? feedbackMessage;
    private bool isSuccessFeedback;

    // Modales
    private bool showForm = false;
    private bool isEditing = false;
    private CategoryFormModel currentCategory = new();
    private CategoryDto? categoryToToggle; // Para el modal de confirmación

    // --- CARGA DE DATOS ---
    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        isLoading = true;
        var result = await CategoryService.GetAllAsync();
        if (result.Success)
        {
            categories = result.Data!;
        }
        else
        {
            ShowError(result.Error);
        }
        isLoading = false;
    }

    // --- FILTRADO EN TIEMPO REAL ---
    private IEnumerable<CategoryDto> FilteredCategories =>
        string.IsNullOrWhiteSpace(searchTerm)
        ? categories
        : categories.Where(c =>
            c.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            c.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    // --- LÓGICA DE FORMULARIO ---
    private void ShowCreateForm()
    {
        currentCategory = new CategoryFormModel();
        isEditing = false;
        showForm = true;
    }

    private void ShowEditForm(CategoryDto category)
    {
        currentCategory = new CategoryFormModel
        {
            Id = category.Id,
            Name = category.Name,
            Description = category.Description,
            IsActive = category.IsActive
        };
        isEditing = true;
        showForm = true;
    }

    private void CloseForm() => showForm = false;

    private async Task SaveCategory()
    {
        isProcessing = true;
        string? error = null;

        if (isEditing)
        {
            var updateDto = new UpdateCategoryDto
            {
                Id = currentCategory.Id,
                Name = currentCategory.Name,
                Description = currentCategory.Description,
                IsActive = currentCategory.IsActive
            };
            var result = await CategoryService.UpdateAsync(updateDto);
            if (!result.Success) error = result.Error;
        }
        else
        {
            var createDto = new CreateCategoryDto
            {
                Name = currentCategory.Name,
                Description = currentCategory.Description
            };
            var result = await CategoryService.CreateAsync(createDto);
            if (!result.Success) error = result.Error;
        }

        if (error == null)
        {
            ShowSuccess(isEditing ? "Categoría actualizada." : "Categoría creada.");
            showForm = false;
            await LoadCategories();
        }
        else
        {
            ShowError(error); // Puedes mostrar el error en el modal o en la página
        }
        isProcessing = false;
    }

    // --- LÓGICA DE ESTADO (ACTIVAR/DESACTIVAR) ---
    private void PromptToggleStatus(CategoryDto category)
    {
        categoryToToggle = category;
    }

    private async Task ExecuteToggleStatus()
    {
        if (categoryToToggle == null) return;

        var result = await CategoryService.ToggleStatusAsync(categoryToToggle.Id);

        if (result.Success)
        {
            var action = categoryToToggle.IsActive ? "desactivada" : "activada";
            ShowSuccess($"Categoría {action} correctamente.");
            await LoadCategories();
        }
        else
        {
            ShowError(result.Error);
        }
        categoryToToggle = null;
    }

    // --- HELPERS ---
    private void ShowSuccess(string msg) { feedbackMessage = msg; isSuccessFeedback = true; }
    private void ShowError(string msg) { feedbackMessage = msg; isSuccessFeedback = false; }

    public class CategoryFormModel
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
    }
}