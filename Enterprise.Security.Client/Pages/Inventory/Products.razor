@page "/products"
@using Enterprise.Security.Client.Core.DTOs.Inventory.Products
@using Enterprise.Security.Client.Core.DTOs.Inventory.Categories
@using Enterprise.Security.Client.Core.Interfaces
@using Enterprise.Security.Client.Core.Common
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = Permissions.Products.View)]
@inject IProductService ProductService
@inject ICategoryService CategoryService
@inject IJSRuntime JS

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Catálogo de Productos</h2>
            <p class="text-muted mb-0">Gestiona el inventario, precios y existencias.</p>
        </div>
        <AuthorizeView Policy="@Permissions.Products.Create">
            <button class="btn btn-primary shadow-sm d-flex align-items-center gap-2 px-4" @onclick="ShowCreateForm">
                <i class="bi bi-plus-lg"></i>
                <span>Nuevo Producto</span>
            </button>
        </AuthorizeView>
    </div>

    @if (!string.IsNullOrEmpty(feedbackMessage))
    {
        <div class="alert @(isSuccessFeedback ? "alert-success" : "alert-danger") alert-dismissible fade show shadow-sm border-0 mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi @(isSuccessFeedback ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") fs-4 me-3"></i>
                <div><strong>@(isSuccessFeedback ? "¡Operación Exitosa!" : "Error")</strong> @feedbackMessage</div>
            </div>
            <button type="button" class="btn-close" @onclick="() => feedbackMessage = null"></button>
        </div>
    }

    <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: var(--radius-lg);">

        <div class="card-header bg-white border-bottom-0 pt-4 px-4 pb-0">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0 bg-light"
                               placeholder="Buscar por nombre o SKU..."
                               @bind="searchTerm" @bind:event="oninput" />
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select bg-light border-0" @bind="selectedCategoryId">
                        <option value="">Todas las Categorías</option>
                        @foreach (var cat in categories)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-5 text-end d-none d-md-block align-self-center">
                    <span class="badge bg-light text-dark border me-2">
                        @FilteredProducts.Count() productos
                    </span>
                    <span class="text-muted small">
                        Valor Inventario: @FilteredProducts.Sum(p => p.UnitPrice * p.StockQuantity).ToString("C")
                    </span>
                </div>
            </div>
        </div>

        <div class="card-body p-0 mt-3">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">Cargando inventario...</p>
                </div>
            }
            else if (!FilteredProducts.Any())
            {
                <div class="text-center py-5">
                    <div class="mb-3 text-muted opacity-25"><i class="bi bi-box-seam display-1"></i></div>
                    <h5 class="text-muted">No se encontraron productos</h5>
                    <p class="text-muted small">Intenta ajustar los filtros de búsqueda.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-uppercase text-muted small fw-bold">
                            <tr>
                                <th class="ps-4 py-3 border-0">Producto</th>
                                <th class="py-3 border-0">Categoría</th>
                                <th class="py-3 border-0">Precio</th>
                                <th class="py-3 border-0" style="width: 20%;">Stock</th>
                                <th class="py-3 border-0">Estado</th>
                                <th class="text-end pe-4 py-3 border-0">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in FilteredProducts)
                            {
                                <tr class="border-bottom-0">
                                    <td class="ps-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-3 bg-light border d-flex align-items-center justify-content-center me-3"
                                                 style="width: 48px; height: 48px; overflow: hidden;">
                                                @if (!string.IsNullOrEmpty(product.ImageUrl))
                                                {
                                                    <img src="@product.ImageUrl" alt="Img" style="width: 100%; height: 100%; object-fit: cover;">
                                                }
                                                else
                                                {
                                                    <i class="bi bi-box-seam text-secondary fs-4"></i>
                                                }
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">@product.Name</div>
                                                <div class="small text-muted font-monospace">SKU: @product.SKU</div>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <span class="badge bg-light text-secondary border fw-normal">
                                            @product.CategoryName
                                        </span>
                                    </td>

                                    <td>
                                        <span class="fw-bold text-dark">@product.UnitPrice.ToString("C")</span>
                                        <div class="small text-muted" style="font-size: 0.7rem;">+ @((product.UnitPrice * product.TaxRate).ToString("C")) Imp.</div>
                                    </td>

                                    <td>
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="fw-bold @(product.StockQuantity <= product.MinStockLevel ? "text-danger" : "text-dark")">
                                                @product.StockQuantity u.
                                            </span>
                                            @if (product.StockQuantity <= product.MinStockLevel)
                                            {
                                                <span class="badge bg-danger-subtle text-danger" style="font-size: 0.65rem;">BAJO</span>
                                            }
                                        </div>
                                        <div class="progress" style="height: 4px;">
                                            @{
                                                // Lógica visual simple para la barra
                                                var percent = product.StockQuantity > 100 ? 100 : product.StockQuantity;
                                                var colorClass = product.StockQuantity <= product.MinStockLevel ? "bg-danger" : "bg-success";
                                            }
                                            <div class="progress-bar @colorClass" role="progressbar" style="width: @percent%"></div>
                                        </div>
                                    </td>

                                    <td>
                                        @if (product.IsActive)
                                        {
                                            <span class="badge bg-success-subtle text-success rounded-pill">Activo</span>
                                        }
                                        else
                                        {

                                            <span class="badge bg-secondary-subtle text-secondary rounded-pill">Inactivo</span>
                                        }
                                    </td>

                                    <td class="text-end pe-4">
                                        <div class="d-flex justify-content-end gap-1">
                                            <AuthorizeView Policy="@Permissions.Products.Edit">
                                                <button class="btn btn-sm btn-action-subtle btn-info-subtle"
                                                        @onclick="() => ShowStockForm(product)"
                                                        title="Ajustar Stock">
                                                    <i class="bi bi-boxes"></i>
                                                </button>
                                                <button class="btn btn-sm btn-action-subtle btn-primary-subtle"
                                                        @onclick="() => ShowEditForm(product)"
                                                        title="Editar">
                                                    <i class="bi bi-pencil-fill"></i>
                                                </button>
                                                @if (product.IsActive)
                                                {
                                                    <button class="btn btn-sm btn-action-subtle btn-danger-subtle"
                                                            @onclick="() => PromptToggleStatus(product)"
                                                            title="Desactivar">
                                                        <i class="bi bi-slash-circle"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-action-subtle btn-success-subtle"
                                                            @onclick="() => PromptToggleStatus(product)"
                                                            title="Activar">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                }
                                            </AuthorizeView>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@if (showForm)
{
    <div class="modal fade show d-block backdrop-blur" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">@(isEditing ? "Editar Producto" : "Nuevo Producto")</h5>
                    <button type="button" class="btn-close" @onclick="CloseForm"></button>
                </div>
                <div class="modal-body p-4">
                    <EditForm Model="@currentProduct" OnValidSubmit="SaveProduct">
                        <DataAnnotationsValidator />

                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Información General</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <InputText id="sku" class="form-control" @bind-Value="currentProduct.SKU" placeholder="SKU" disabled="@isEditing" />
                                    <label for="sku">SKU (Código)</label>
                                    <ValidationMessage For="@(() => currentProduct.SKU)" />
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <InputText id="name" class="form-control" @bind-Value="currentProduct.Name" placeholder="Nombre" />
                                    <label for="name">Nombre del Producto</label>
                                    <ValidationMessage For="@(() => currentProduct.Name)" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <InputSelect id="cat" class="form-select" @bind-Value="currentProduct.CategoryId">
                                        <option value="">-- Seleccionar --</option>
                                        @foreach (var cat in categories)
                                        {
                                            <option value="@cat.Id">@cat.Name</option>
                                        }
                                    </InputSelect>
                                    <label for="cat">Categoría</label>
                                    <ValidationMessage For="@(() => currentProduct.CategoryId)" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <InputText id="img" class="form-control" @bind-Value="currentProduct.ImageUrl" placeholder="URL" />
                                    <label for="img">URL Imagen (Opcional)</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <InputTextArea id="desc" class="form-control" @bind-Value="currentProduct.Description" placeholder="Desc" style="height: 80px;" />
                                    <label for="desc">Descripción</label>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Precios e Inventario Inicial</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <InputNumber id="price" class="form-control" @bind-Value="currentProduct.UnitPrice" placeholder="0.00" />
                                    <label for="price">Precio Unitario</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <InputNumber id="tax" class="form-control" @bind-Value="currentProduct.TaxRate" placeholder="0.15" />
                                    <label for="tax">Impuesto (0.15)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <InputNumber id="minStock" class="form-control" @bind-Value="currentProduct.MinStockLevel" placeholder="5" />
                                    <label for="minStock">Alerta Stock Mínimo</label>
                                </div>
                            </div>

                            @if (!isEditing) // Solo al crear permitimos setear stock inicial directo
                            {
                                <div class="col-md-12">
                                    <div class="form-floating">
                                        <InputNumber id="stock" class="form-control bg-light" @bind-Value="currentProduct.StockQuantity" placeholder="0" />
                                        <label for="stock">Stock Inicial</label>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="d-grid gap-2 mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-primary shadow-sm" disabled="@isProcessing">
                                @(isProcessing ? "Guardando..." : "Guardar Producto")
                            </button>
                            <button type="button" class="btn btn-light text-muted" @onclick="CloseForm">Cancelar</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@if (showStockForm && currentStockProduct != null)
{
    <div class="modal fade show d-block backdrop-blur" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <div class="modal-header border-bottom-0 bg-light">
                    <div>
                        <h5 class="modal-title fw-bold text-dark">Ajuste de Inventario</h5>
                        <div class="small text-muted">@currentStockProduct.Name (SKU: @currentStockProduct.SKU)</div>
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseStockForm"></button>
                </div>
                <div class="modal-body p-4">
                    <EditForm Model="@stockAdjustment" OnValidSubmit="SaveStockAdjustment">
                        <DataAnnotationsValidator />

                        <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white border rounded shadow-sm">
                            <div class="text-muted small text-uppercase fw-bold">Stock Actual</div>
                            <div class="fs-4 fw-bold text-dark">@currentStockProduct.StockQuantity <small class="fs-6 text-muted fw-normal">unidades</small></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Cantidad a Ajustar</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text @(stockAdjustment.QuantityAdjustment > 0 ? "bg-success text-white" : (stockAdjustment.QuantityAdjustment < 0 ? "bg-danger text-white" : "bg-light"))">
                                    @if (stockAdjustment.QuantityAdjustment > 0)
                                    {
                                        <i class="bi bi-plus-lg"></i>
                                    }
                                    else if (stockAdjustment.QuantityAdjustment < 0)
                                    {

                                        <i class="bi bi-dash-lg"></i>
                                    }
                                    else
                                    {

                                        <i class="bi bi-circle"></i>
                                    }
                                </span>
                                <InputNumber class="form-control fw-bold" @bind-Value="stockAdjustment.QuantityAdjustment" placeholder="0" />
                            </div>
                            <div class="form-text small mt-1">
                                @if (stockAdjustment.QuantityAdjustment > 0)
                                {
                                    <span class="text-success fw-medium">Estás AGREGANDO inventario (Entrada).</span>
                                }
                                else if (stockAdjustment.QuantityAdjustment < 0)
                                {

                                    <span class="text-danger fw-medium">Estás QUITANDO inventario (Salida/Merma).</span>
                                }
                                else
                                {

                                    <span>Ingresa un valor positivo o negativo.</span>
                                }
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            <InputText id="reason" class="form-control" @bind-Value="stockAdjustment.Reason" placeholder="Motivo" />
                            <label for="reason">Motivo del ajuste (Requerido para auditoría)</label>
                            <ValidationMessage For="@(() => stockAdjustment.Reason)" />
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg shadow-sm" disabled="@(stockAdjustment.QuantityAdjustment == 0)">
                                Aplicar Ajuste
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@if (productToToggle != null)
{
    <div class="modal fade show d-block backdrop-blur" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content shadow rounded-4 border-0">
                <div class="modal-body text-center p-4">
                    <div class="mb-3">
                        @if (productToToggle.IsActive)
                        {
                            <div class="rounded-circle bg-danger-subtle text-danger d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="bi bi-slash-circle fs-2"></i>
                            </div>
                        }
                        else
                        {
                            <div class="rounded-circle bg-success-subtle text-success d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="bi bi-check-circle fs-2"></i>
                            </div>
                        }
                </div>
                <h5 class="fw-bold">¿Confirmar Acción?</h5>
                <p class="text-muted small">
                    @(productToToggle.IsActive
                                        ? $"Se desactivará '{productToToggle.Name}'."
                                        : $"Se reactivará '{productToToggle.Name}'.")
                    </p>
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn @(productToToggle.IsActive ? "btn-danger" : "btn-success")" @onclick="ExecuteToggleStatus">
                            Sí, @(productToToggle.IsActive ? "Desactivar" : "Activar")
                        </button>
                        <button class="btn btn-link text-decoration-none text-muted btn-sm" @onclick="() => productToToggle = null">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Estilos Locales */
    .backdrop-blur {
        background-color: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
    }

    .btn-action-subtle {
        border: none;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        transition: all 0.2s;
    }

    .btn-info-subtle {
        background-color: #e0f2fe;
        color: #0284c7;
    }

        .btn-info-subtle:hover {
            background-color: #0ea5e9;
            color: white;
            transform: translateY(-2px);
        }

    .btn-primary-subtle {
        background-color: #f1f5f9;
        color: #475569;
    }

        .btn-primary-subtle:hover {
            background-color: #334155;
            color: white;
            transform: translateY(-2px);
        }

    .btn-danger-subtle {
        background-color: #fee2e2;
        color: #ef4444;
    }

        .btn-danger-subtle:hover {
            background-color: #dc2626;
            color: white;
            transform: translateY(-2px);
        }

    .btn-success-subtle {
        background-color: #dcfce7;
        color: #16a34a;
    }

        .btn-success-subtle:hover {
            background-color: #16a34a;
            color: white;
            transform: translateY(-2px);
        }
</style>

@code {
    // --- VARIABLES ---
    private List<ProductDto> products = new();
    private List<CategoryDto> categories = new();
    private bool isLoading = true;
    private bool isProcessing = false;

    // Filtros
    private string searchTerm = "";
    private string selectedCategoryId = "";

    // Feedback
    private string? feedbackMessage;
    private bool isSuccessFeedback;

    // Modales
    private bool showForm = false;
    private bool isEditing = false;
    private bool showStockForm = false;

    private ProductFormModel currentProduct = new();
    private ProductDto? currentStockProduct;
    private ProductDto? productToToggle; // Para confirmar
    private AdjustStockDto stockAdjustment = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        // Carga paralela para eficiencia
        var catTask = CategoryService.GetAllAsync();
        var prodTask = ProductService.GetAllAsync();

        await Task.WhenAll(catTask, prodTask);

        var catResult = await catTask;
        if (catResult.Success) categories = catResult.Data!;

        var prodResult = await prodTask;
        if (prodResult.Success) products = prodResult.Data!;
        else ShowError(prodResult.Error);

        isLoading = false;
    }

    private async Task LoadProducts()
    {
        var result = await ProductService.GetAllAsync();
        if (result.Success) products = result.Data!;
    }

    // --- FILTRADO ---
    private IEnumerable<ProductDto> FilteredProducts
    {
        get
        {
            var query = products.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(selectedCategoryId))
            {
                if (Guid.TryParse(selectedCategoryId, out Guid catGuid))
                    query = query.Where(p => p.CategoryId == catGuid);
            }

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                query = query.Where(p =>
                    p.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    p.SKU.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            return query;
        }
    }

    // --- FORMULARIO CRUD ---
    private void ShowCreateForm()
    {
        currentProduct = new ProductFormModel();
        isEditing = false;
        showForm = true;
    }

    private void ShowEditForm(ProductDto p)
    {
        currentProduct = new ProductFormModel
        {
            Id = p.Id,
            CategoryId = p.CategoryId,
            SKU = p.SKU,
            Name = p.Name,
            Description = p.Description,
            UnitPrice = p.UnitPrice,
            TaxRate = p.TaxRate,
            StockQuantity = p.StockQuantity,
            MinStockLevel = p.MinStockLevel,
            ImageUrl = p.ImageUrl
        };
        isEditing = true;
        showForm = true;
    }

    private void CloseForm() => showForm = false;

    private async Task SaveProduct()
    {
        isProcessing = true;
        string? error = null;

        if (isEditing)
        {
            var updateDto = new UpdateProductDto
            {
                Id = currentProduct.Id,
                CategoryId = currentProduct.CategoryId,
                Name = currentProduct.Name,
                Description = currentProduct.Description,
                UnitPrice = currentProduct.UnitPrice,
                TaxRate = currentProduct.TaxRate,
                MinStockLevel = currentProduct.MinStockLevel,
                ImageUrl = currentProduct.ImageUrl,
                IsActive = true
            };
            var result = await ProductService.UpdateAsync(updateDto);
            if (!result.Success) error = result.Error;
        }
        else
        {
            var createDto = new CreateProductDto
            {
                CategoryId = currentProduct.CategoryId,
                SKU = currentProduct.SKU,
                Name = currentProduct.Name,
                Description = currentProduct.Description,
                UnitPrice = currentProduct.UnitPrice,
                TaxRate = currentProduct.TaxRate,
                StockQuantity = currentProduct.StockQuantity,
                MinStockLevel = currentProduct.MinStockLevel,
                ImageUrl = currentProduct.ImageUrl
            };
            var result = await ProductService.CreateAsync(createDto);
            if (!result.Success) error = result.Error;
        }

        if (error == null)
        {
            ShowSuccess(isEditing ? "Producto actualizado." : "Producto creado.");
            showForm = false;
            await LoadProducts();
        }
        else ShowError(error);

        isProcessing = false;
    }

    // --- ESTADO ---
    private void PromptToggleStatus(ProductDto product) { productToToggle = product; }

    private async Task ExecuteToggleStatus()
    {
        if (productToToggle == null) return;
        var result = await ProductService.ToggleStatusAsync(productToToggle.Id);

        if (result.Success)
        {
            ShowSuccess(productToToggle.IsActive ? "Producto desactivado." : "Producto activado.");
            await LoadProducts();
        }
        else ShowError(result.Error);

        productToToggle = null;
    }

    // --- AJUSTE STOCK ---
    private void ShowStockForm(ProductDto product)
    {
        currentStockProduct = product;
        stockAdjustment = new AdjustStockDto { ProductId = product.Id, QuantityAdjustment = 0, Reason = "" };
        showStockForm = true;
    }

    private void CloseStockForm() => showStockForm = false;

    private async Task SaveStockAdjustment()
    {
        var result = await ProductService.AdjustStockAsync(stockAdjustment);
        if (result.Success)
        {
            ShowSuccess("Inventario ajustado correctamente.");
            showStockForm = false;
            await LoadProducts();
        }
        else ShowError(result.Error);
    }

    // --- HELPERS ---
    private void ShowSuccess(string msg) { feedbackMessage = msg; isSuccessFeedback = true; }
    private void ShowError(string msg) { feedbackMessage = msg; isSuccessFeedback = false; }

    public class ProductFormModel
    {
        public Guid Id { get; set; }
        public Guid CategoryId { get; set; }
        public string SKU { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal UnitPrice { get; set; }
        public decimal TaxRate { get; set; } = 0.15m;
        public int StockQuantity { get; set; }
        public int MinStockLevel { get; set; } = 5;
        public string? ImageUrl { get; set; }
    }
}