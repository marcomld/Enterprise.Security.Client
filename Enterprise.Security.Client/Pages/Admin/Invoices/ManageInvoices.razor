@page "/manage-invoices"
@using Enterprise.Security.Client.Core.DTOs.Invoicing
@using Enterprise.Security.Client.Core.Interfaces
@using Enterprise.Security.Client.Core.Common
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = Permissions.Invoices.ViewAll)]
@inject IInvoiceService InvoiceService

<div class="container-fluid py-4">

    <div class="row mb-4 align-items-end g-3">
        <div class="col-md-6">
            <h2 class="fw-bold text-dark mb-1">Registro de Facturación</h2>
            <p class="text-muted mb-0">Historial completo de ingresos generados.</p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="d-inline-flex bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-3 p-3 text-start align-items-center gap-3">
                <div class="bg-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 48px; height: 48px;">
                    <i class="bi bi-cash-stack fs-4"></i>
                </div>
                <div>
                    <span class="d-block small text-uppercase fw-bold opacity-75 lh-1 mb-1">Ingresos Totales</span>
                    <span class="fs-4 fw-bold lh-1">@allInvoices.Sum(x => x.TotalAmount).ToString("C")</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: var(--radius-lg);">
        <div class="card-header bg-white border-bottom-0 pt-4 px-4 pb-0">
            <div class="row">
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0 bg-light"
                               placeholder="Buscar factura, cliente o vendedor..."
                               @bind="searchTerm" @bind:event="oninput" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body p-0 mt-3">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            }
            else if (!FilteredInvoices.Any())
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-receipt display-1 opacity-25 d-block mb-3"></i>
                    <h5>No hay registros</h5>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-uppercase small text-muted fw-bold">
                            <tr>
                                <th class="ps-4 py-3 border-0">Nro. Factura</th>
                                <th class="py-3 border-0">Fecha Emisión</th>
                                <th class="py-3 border-0">Cliente</th>
                                <th class="py-3 border-0">Canal / Vendedor</th>
                                <th class="text-end py-3 border-0">Subtotal</th>
                                <th class="text-end pe-4 py-3 border-0">Total Pagado</th>
                                <th class="text-center border-0">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in FilteredInvoices)
                            {
                                <tr class="border-bottom-0">
                                    <td class="ps-4 fw-bold font-monospace text-primary">@invoice.InvoiceNumber</td>
                                    <td class="text-muted small">@invoice.IssuedDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                    <td class="fw-medium text-dark">@invoice.ClientName</td>
                                    <td>
                                        @if (string.IsNullOrEmpty(invoice.SellerName))
                                        {
                                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle fw-normal"><i class="bi bi-globe me-1"></i> E-commerce</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle fw-normal"><i class="bi bi-person-badge me-1"></i> @invoice.SellerName</span>
                                        }
                                    </td>
                                    <td class="text-end text-muted small">@invoice.SubTotal.ToString("C")</td>
                                    <td class="text-end pe-4 fw-bold text-success fs-6">@invoice.TotalAmount.ToString("C")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary border-0" @onclick="() => ShowDetails(invoice)" title="Ver Documento">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@* --- MODAL DE DETALLE TIPO RECIBO --- *@
@if (selectedInvoice != null)
{
    <div class="modal fade show d-block backdrop-blur" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <div class="modal-header border-bottom pb-4 bg-light align-items-start rounded-top-4">
                    <div>
                        <h4 class="modal-title fw-bold text-dark mb-1">Copia de Factura</h4>
                        <div class="text-muted font-monospace small">No. @selectedInvoice.InvoiceNumber</div>
                    </div>
                    <div class="text-end">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Total Pagado</div>
                        <h3 class="fw-bold text-primary mb-0">@selectedInvoice.TotalAmount.ToString("C")</h3>
                    </div>
                </div>

                <div class="modal-body p-4">
                    <div class="row mb-4 g-3 bg-light-subtle p-3 rounded-3 border">
                        <div class="col-sm-6">
                            <span class="d-block small text-muted text-uppercase fw-bold mb-1">Facturado a:</span>
                            <div class="fw-semibold text-dark">@selectedInvoice.ClientName</div>
                            @if (selectedInvoice.OrderId.HasValue)
                            {
                                <div class="text-muted small mt-1">Ref. Pedido: <span class="font-monospace">@selectedInvoice.OrderId.Value.ToString().Substring(0, 8).ToUpper()</span></div>
                            }
                        </div>
                        <div class="col-sm-6 text-sm-end">
                            <span class="d-block small text-muted text-uppercase fw-bold mb-1">Detalles de Emisión:</span>
                            <div class="text-dark small mb-1"><strong>Fecha:</strong> @selectedInvoice.IssuedDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                            <div class="text-dark small">
                                <strong>Vendedor:</strong> @(string.IsNullOrEmpty(selectedInvoice.SellerName) ? "E-commerce" : selectedInvoice.SellerName)
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive border rounded-3 mb-4">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="ps-3 border-0 py-2">Artículo</th>
                                    <th class="text-center border-0 py-2">Cant.</th>
                                    <th class="text-end border-0 py-2">P. Unit.</th>
                                    <th class="text-end pe-3 border-0 py-2">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in selectedInvoice.Items)
                                {
                                    <tr class="border-top">
                                        <td class="ps-3 py-2">
                                            <div class="fw-semibold text-dark">@item.ProductName</div>
                                            <div class="small text-muted font-monospace">@item.ProductSku</div>
                                        </td>
                                        <td class="text-center text-dark">@item.Quantity</td>
                                        <td class="text-end text-muted small">@item.UnitPrice.ToString("C")</td>
                                        <td class="text-end pe-3 fw-medium text-dark">@item.SubTotal.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="row justify-content-end">
                        <div class="col-sm-6 col-md-5">
                            <div class="d-flex justify-content-between mb-2 text-muted small">
                                <span>Subtotal:</span>
                                <span>@selectedInvoice.SubTotal.ToString("C")</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3 text-muted small">
                                <span>Impuestos:</span>
                                <span>@selectedInvoice.TaxAmount.ToString("C")</span>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-2">
                                <span class="fw-bold text-dark">Total:</span>
                                <span class="fw-bold text-dark">@selectedInvoice.TotalAmount.ToString("C")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-top-0 pt-0 pb-4 px-4 bg-white d-flex justify-content-between">
                    <button class="btn btn-outline-secondary d-flex align-items-center gap-2" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimir Copia
                    </button>
                    <button type="button" class="btn btn-primary px-4" @onclick="() => selectedInvoice = null">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .bg-primary-subtle {
        background-color: #e0f2fe;
        color: #0369a1;
    }

    .bg-secondary-subtle {
        background-color: #f1f5f9;
        color: #475569;
    }

    .backdrop-blur {
        background-color: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
    }

    @@media print {
        .modal {
            position: absolute !important;
            left: 0;
            top: 0;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .modal-dialog {
            max-width: 100%;
            margin: 0;
            padding: 0;
            align-items: flex-start !important;
            min-height: auto !important;
            transform: none !important;
        }

        .modal-content {
            border: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        .modal-footer, .btn-close {
            display: none !important;
        }
    }
</style>
@code {
    private List<InvoiceResponseDto> allInvoices = new();
    private bool isLoading = true;
    private string searchTerm = "";
    private InvoiceResponseDto? selectedInvoice;

    private IEnumerable<InvoiceResponseDto> FilteredInvoices =>
        string.IsNullOrWhiteSpace(searchTerm)
        ? allInvoices
        : allInvoices.Where(i =>
            i.InvoiceNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            i.ClientName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            (i.SellerName != null && i.SellerName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))); // <-- Añadida búsqueda por vendedor

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var result = await InvoiceService.GetAllInvoicesAsync();
        if (result.Success)
        {
            allInvoices = result.Data!.OrderByDescending(x => x.IssuedDate).ToList();
        }
        isLoading = false;
    }

    private void ShowDetails(InvoiceResponseDto invoice)
    {
        selectedInvoice = invoice;
    }
}